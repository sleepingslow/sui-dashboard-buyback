<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>$BLUE Buyback Monitor — Sui via Suiscan (Client-side)</title>
  <meta name="description" content="Bluefin-styled dashboard to monitor $BLUE buybacks on Sui. Client-side ingestion from Suiscan (Blockberry API) or CSV/JSON."/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--panel:#0f152b;--panel-2:#121a35;--text:#d9e1ff;--muted:#94a3b8;--accent:#3b82f6;--accent-2:#22d3ee;--positive:#34d399;--negative:#ef4444;--border:rgba(255,255,255,.06);--chip:#1e2a52;--shadow:0 12px 24px rgba(19,36,90,.35);--radius:14px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background: radial-gradient(1200px 600px at 70% -10%, rgba(59,130,246,.16), rgba(0,0,0,0) 60%),radial-gradient(900px 500px at -10% 10%, rgba(34,211,238,.10), rgba(0,0,0,0) 60%),var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1260px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#1e40af);box-shadow:0 0 0 3px rgba(59,130,246,.25), 0 10px 24px rgba(59,130,246,.35)}
    .title{font-weight:800;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:.92rem}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg,#1a2350,#111936);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .2s;box-shadow: inset 0 0 0 1px rgba(255,255,255,.04)}
    .btn:hover{transform:translateY(-1px);background:linear-gradient(180deg,#20306b,#131d42)}
    .btn.accent{background:linear-gradient(180deg,#2563eb,#1e40af);border-color:#1d4ed8}
    .filters{display:grid;grid-template-columns:1.15fr 1fr 1fr .9fr 1fr;gap:12px;margin:12px 0 18px}
    .field{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.78rem;color:var(--muted)}
    .field input,.field select{background:transparent;border:none;outline:none;color:var(--text);font-size:.96rem}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:12px 0 18px}
    .card{background:linear-gradient(180deg,var(--panel),#0b122a);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .card .label{color:var(--muted);font-size:.85rem}
    .card .value{font-size:1.6rem;font-weight:800;margin-top:6px}
    .trend{font-size:.82rem;margin-top:8px}
    .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel),#0a1024);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .panel h3{margin:0 0 12px;font-size:1.05rem}
    canvas{width:100% !important;height:340px !important}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:720px;background:var(--panel)}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;font-size:.92rem}
    th{color:var(--muted);font-weight:600;background:linear-gradient(180deg,#0f162d,#0b1126)}
    tr:hover td{background:var(--panel-2)}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);font-size:.78rem;color:#c7d2fe}
    .status.buy{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.35)}
    .hash{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace; font-size:.82rem}
    .pagination{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .pagination button{padding:8px 10px;border-radius:10px;background:#0e1633;border:1px solid var(--border);color:var(--text);cursor:pointer}
    .badge{padding:6px 8px;border-radius:8px;background:linear-gradient(180deg,#0f1a3a,#0b122a);border:1px solid var(--border);font-size:.8rem;color:#b6c3ff}
    footer{margin:18px 0;color:var(--muted);font-size:.85rem}
    @media (max-width:1100px){.filters{grid-template-columns:1fr 1fr} .grid{grid-template-columns:1fr} .kpis{grid-template-columns:1fr 1fr}}
    .small{font-size:.85rem;color:var(--muted)}
    .error{color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">$BLUE Buyback Monitor</div>
          <div class="subtitle">Sui on-chain buybacks — direct from Suiscan (Blockberry API) or CSV/JSON</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnDemo">Load Demo</button>
        <button class="btn accent" id="btnRefresh">Refresh</button>
      </div>
    </header>

    <div class="filters">
      <div class="field">
        <label>$BLUE Contract (Sui Move)</label>
        <input id="inpContract" value="0xe1b45a0e641b9955a20aa0ad1c1f4ad86aad8afb07296d4085e349a50e90bdca::blue::BLUE" />
      </div>
      <div class="field">
        <label>Buyback Wallet</label>
        <input id="inpWallet" value="0xf59fe3c0f25f1415a44b1d29392c36b092926443615cb05753438eeb1b3f5cfa" />
      </div>
      <div class="field">
        <label>Time Range</label>
        <select id="selRange">
          <option value="7">7 days</option>
          <option value="30" selected>30 days</option>
          <option value="90">90 days</option>
          <option value="365">1 year</option>
          <option value="all">All</option>
        </select>
      </div>
      <div class="field">
        <label>Suiscan API Key (Blockberry)</label>
        <input id="inpApiKey" placeholder="paste x-api-key here" />
        <div class="small">Free during campaign (per docs). Needed for browser calls.</div>
      </div>
      <div class="field" style="display:flex;align-items:end">
        <div class="badge">Source: Suiscan API</div>
      </div>
    </div>

    <div class="kpis">
      <div class="card"><div class="label">Total Buybacks (BLUE)</div><div class="value" id="kpiTotalBlue">—</div><div class="trend" id="kpiAvgPrice">—</div></div>
      <div class="card"><div class="label">Est. Value (USD)</div><div class="value" id="kpiUsdValue">—</div><div class="trend" id="kpiSpot">—</div></div>
      <div class="card"><div class="label">Transactions</div><div class="value" id="kpiTxCount">—</div><div class="trend" id="kpiLastBuy">—</div></div>
      <div class="card"><div class="label">Unique Buy Days</div><div class="value" id="kpiDays">—</div><div class="trend" id="kpiDailyAvg">—</div></div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Cumulative Buybacks (BLUE)</h3>
        <canvas id="chartCumulative"></canvas>
      </div>
      <div class="panel">
        <h3>Daily Volume (BLUE)</h3>
        <canvas id="chartDaily"></canvas>
      </div>
    </div>

    <div class="panel" style="margin-top:14px">
      <h3>On-chain Transactions (Sui — Suiscan)</h3>
      <div class="table-wrap">
        <table id="tblOnChain">
          <thead><tr><th>Date</th><th>Hash</th><th>Type</th><th>Amount (BLUE)</th><th>Est. Price (USD)</th><th>Counterparty</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination" id="pgOnChain"></div>
      <div class="small" style="margin-top:8px">Links: <a target="_blank" href="https://suiscan.xyz/">SuiScan</a> · <a target="_blank" href="https://suivision.xyz/">SuiVision</a></div>
      <div id="apiError" class="small error"></div>
    </div>

    <footer>
      <div>This is a static client-only app. For production, consider a tiny proxy if your API key must be hidden.</div>
    </footer>
  </div>

<script>
const fmt = {{
  n:(x,d=2)=>Number(x||0).toLocaleString('en-US',{{maximumFractionDigits:d,minimumFractionDigits:d}}),
  i:(x)=>Number(x||0).toLocaleString('en-US'),
  k:(x)=>{{const n=Number(x||0); if(Math.abs(n)>=1e9)return(n/1e9).toFixed(2)+'B'; if(Math.abs(n)>=1e6)return(n/1e6).toFixed(2)+'M'; if(Math.abs(n)>=1e3)return(n/1e3).toFixed(2)+'k'; return String(n)}},
  date:(iso)=>new Date(iso).toLocaleString('en-US',{{hour12:false}}),
  shortDate:(iso)=>new Date(iso).toLocaleDateString('en-US'),
  hash:(h)=>h?(h.slice(0,10)+'…'+h.slice(-6)):'—'
}};
const linkSuiTx = (hash)=>`https://suiscan.xyz/mainnet/tx/${{hash}}`;

const state = {{ onchain:[], page:1, per:8, priceBLUE_USD:0.32 }};

// Charts
let chartCumul, chartDaily;
function computeKpis(){{
  const total = state.onchain.reduce((s,r)=>s+(r.amountBLUE||0),0);
  const sorted = state.onchain.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
  const last = sorted[0];
  const avgPrice = state.onchain.length? state.onchain.reduce((s,r)=>s+(r.priceUSD||0)*(r.amountBLUE||0),0)/Math.max(total,1) : 0;
  const days = new Set(state.onchain.map(r=>new Date(r.date).toISOString().slice(0,10)));
  document.getElementById('kpiTotalBlue').textContent = fmt.k(total);
  document.getElementById('kpiAvgPrice').textContent  = (total&&avgPrice)?`Avg buy price ≈ $${{fmt.n(avgPrice,4)}}`:'—';
  document.getElementById('kpiUsdValue').textContent  = `$ ${{fmt.k(total*(state.priceBLUE_USD||avgPrice||0))}}`;
  document.getElementById('kpiSpot').textContent      = `Spot ≈ $ ${{fmt.n(state.priceBLUE_USD,4)}}`;
  document.getElementById('kpiTxCount').textContent   = fmt.i(state.onchain.length);
  document.getElementById('kpiLastBuy').textContent   = last?`Last buy: ${{fmt.date(last.date)}}`:'—';
  document.getElementById('kpiDays').textContent      = fmt.i(days.size);
  document.getElementById('kpiDailyAvg').textContent  = days.size?`Daily avg ≈ ${{fmt.k(total/days.size)}} BLUE`:'—';
}}
function renderCharts(){{
  const byDay={{}}; const sorted=state.onchain.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  let cumul=0; const labels=[], seriesC=[], seriesD=[];
  sorted.forEach(r=>{{ const key=new Date(r.date).toISOString().slice(0,10); byDay[key]=(byDay[key]||0)+r.amountBLUE; }});
  Object.keys(byDay).sort().forEach(day=>{{ cumul+=byDay[day]; labels.push(day); seriesC.push(cumul); seriesD.push(byDay[day]); }});
  const opts={{responsive:true, animation:{{duration:400}}, plugins:{{legend:{{display:false}}, tooltip:{{mode:'index',intersect:false,backgroundColor:'#0b1020',titleColor:'#cbd5e1',bodyColor:'#e2e8f0',borderColor:'#1f2a4d',borderWidth:1}}}, scales:{{x:{{grid:{{color:'rgba(255,255,255,.05)'}}}}, y:{{grid:{{color:'rgba(255,255,255,.05)'}}}}}}};
  if(chartCumul) chartCumul.destroy();
  chartCumul=new Chart(document.getElementById('chartCumulative'),{{type:'line',data:{{labels,datasets:[{{data:seriesC,tension:.35,borderWidth:2,fill:true,backgroundColor:'rgba(59,130,246,.18)',borderColor:'rgba(59,130,246,.95)'}}]}},options:opts}});
  if(chartDaily) chartDaily.destroy();
  chartDaily=new Chart(document.getElementById('chartDaily'),{{type:'bar',data:{{labels,datasets:[{{data:seriesD,borderWidth:0,backgroundColor:'rgba(34,211,238,.75)'}}]}},options:opts}});
}}
function paginate(arr,page,per){{const s=(page-1)*per; return arr.slice(s,s+per);}}
function renderTable(){{
  const tbody=document.querySelector('#tblOnChain tbody'); tbody.innerHTML='';
  const pageRows = paginate(state.onchain.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)), state.page, state.per);
  pageRows.forEach(r=>{{ const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${{fmt.date(r.date)}}></td>
      <td class="hash"><a target="_blank" href="${{linkSuiTx(r.hash)}}">${{fmt.hash(r.hash)}}</a></td>
      <td><span class="chip status buy">${{r.type||'BUYBACK'}}</span></td>
      <td>${{fmt.n(r.amountBLUE,0)}}</td>
      <td>${{r.priceUSD!=null ? fmt.n(r.priceUSD,4)+' $' : '—'}}</td>
      <td>${{r.counterparty||'—'}}</td>`; tbody.appendChild(tr); }});
  renderPagination('pgOnChain', state.onchain.length, state.page, p=>{{ state.page=p; renderTable(); }});
}}
function renderPagination(id,total,page,onClick){{
  const el=document.getElementById(id); el.innerHTML=''; const pages=Math.max(1,Math.ceil(total/state.per));
  const mk=(t,p,dis)=>{{const b=document.createElement('button'); b.textContent=t; if(dis){{b.disabled=true;b.style.opacity=.6}} b.onclick=()=>onClick(p); return b;}};
  el.appendChild(mk('«',1,page===1)); el.appendChild(mk('‹',Math.max(1,page-1),page===1));
  el.appendChild(document.createTextNode(` Page ${{page}} / ${{pages}} `));
  el.appendChild(mk('›',Math.min(pages,page+1),page===pages)); el.appendChild(mk('»',pages,page===pages));
}}

// -------- Suiscan / Blockberry integration (client-side) --------
// Docs: getTransactionsByCoinType (POST /sui/v1/coins/{{coinType}}/transactions)
//       getAccountTransactions (GET  /sui/v1/accounts/{{address}}/transactions)
// Both are marked Pro but currently free per docs.
const SUISCAN_BASE = "https://api.blockberry.one/sui/v1";

async function fetchSuiscan(endpoint, method='GET', body=null, apiKey=''){{
  const headers={{'Content-Type':'application/json'}};
  if(apiKey) headers['x-api-key']=apiKey;
  const res = await fetch(`${{SUISCAN_BASE}}${{endpoint}}`, {{ method, headers, body: body?JSON.stringify(body):null }});
  if(!res.ok) throw new Error(`HTTP ${{res.status}}`);
  return res.json();
}}

// Map Blockberry transaction record -> dashboard row
function mapTxToRow(tx, wallet, coinType){{
  let amountBLUE = 0, priceUSD = null, counterparty='';
  const dateISO = tx.timestamp ? new Date(tx.timestamp).toISOString() :
                 (tx.time? new Date(tx.time).toISOString() : new Date().toISOString());
  const hash = tx.digest || tx.hash || tx.txHash || tx.transactionHash || '';
  const ch = (tx.balanceChanges||tx.changes||[]);
  ch.forEach(c=>{{
    const owner = c.owner || c.address || '';
    const ct = c.coinType || c.type || '';
    const amt = Number(c.amount || c.delta || 0);
    if(owner && owner.toLowerCase()===wallet.toLowerCase() && ct && ct.toLowerCase()===coinType.toLowerCase()){{ amountBLUE += amt; }}
  }});
  const transfers = tx.transfers || tx.coinTransfers || [];
  transfers.forEach(t=>{{
    const to = (t.to||'').toLowerCase();
    const ct = t.coinType || t.type || '';
    const amt = Number(t.amount||0);
    if(to && to===wallet.toLowerCase() && ct && ct.toLowerCase()===coinType.toLowerCase()){{ amountBLUE += amt; counterparty = t.from || counterparty; }}
  }});
  if(!hash) return null;
  return {{ date: dateISO, hash, type: 'BUYBACK', amountBLUE: Math.max(0,amountBLUE), priceUSD, counterparty }};
}}

async function loadFromSuiscan(){{
  const coinType = document.getElementById('inpContract').value.trim();
  const wallet   = document.getElementById('inpWallet').value.trim();
  const apiKey   = document.getElementById('inpApiKey').value.trim();
  const err = document.getElementById('apiError'); err.textContent='';

  if(!apiKey){{
    err.textContent='Missing x-api-key for Suiscan/Blockberry';
    return;
  }}

  let list = [];
  try{{
    const pageSize = 50;
    for(let page=1; page<=3; page++){{ 
      const body = {{ page, pageSize }};
      const json = await fetchSuiscan(`/coins/${{encodeURIComponent(coinType)}}/transactions`, 'POST', body, apiKey);
      const items = json?.data || json?.items || json || [];
      items.forEach(tx=>{{ const row = mapTxToRow(tx, wallet, coinType); if(row && row.amountBLUE>0) list.push(row); }});
      if((items?.length||0) < pageSize) break;
    }}
  }}catch(e){{
    console.warn('coinType fetch failed', e);
  }}

  if(list.length===0){{
    try{{ 
      const pageSize=50;
      for(let page=1; page<=3; page++){{ 
        const qs = new URLSearchParams({{ page:String(page), pageSize:String(pageSize) }});
        const json = await fetchSuiscan(`/accounts/${{wallet}}/transactions?${{qs}}`, 'GET', null, apiKey);
        const items = json?.data || json?.items || json || [];
        items.forEach(tx=>{{ const row = mapTxToRow(tx, wallet, coinType); if(row && row.amountBLUE>0) list.push(row); }});
        if((items?.length||0) < pageSize) break;
      }}
    }}catch(e){{
      err.textContent = 'Suiscan account fetch error: '+e.message;
    }}
  }}

  state.onchain = list.sort((a,b)=> new Date(a.date)-new Date(b.date));
  const seen={{}}; state.onchain = state.onchain.filter(r=> !seen[r.hash] && (seen[r.hash]=true));
  computeKpis(); renderCharts(); state.page=1; renderTable();
}}

// Demo data
const DEMO = [
  {{date:'2025-09-28T10:14:00Z', hash:'Gn9x5a2b1c0d9e', type:'BUYBACK', amountBLUE: 180000, priceUSD:0.30, counterparty:'Pool'}},
  {{date:'2025-09-29T15:40:00Z', hash:'Ab1cf39e21aa54', type:'BUYBACK', amountBLUE: 220000, priceUSD:0.31, counterparty:'Pool'}},
  {{date:'2025-09-30T09:07:00Z', hash:'Kp0qc339aa129a', type:'BUYBACK', amountBLUE: 160000, priceUSD:0.33, counterparty:'Pool'}},
  {{date:'2025-10-01T12:21:00Z', hash:'Zz7rdd12904f71', type:'BUYBACK', amountBLUE: 300000, priceUSD:0.32, counterparty:'Pool'}},
  {{date:'2025-10-02T11:10:00Z', hash:'Tx9v9aa11077b3', type:'BUYBACK', amountBLUE: 95000,  priceUSD:0.34, counterparty:'Pool'}}
];

function loadDemo(){{
  state.onchain = DEMO.slice();
  computeKpis(); renderCharts(); state.page=1; renderTable();
}}

document.getElementById('btnDemo').addEventListener('click', loadDemo);
document.getElementById('btnRefresh').addEventListener('click', ()=> loadFromSuiscan());
window.addEventListener('load', loadDemo);
</script>
</body>
</html>
